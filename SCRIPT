-- ESP (Extra Sensory Perception) Script - Server-Sided (Place in ServerScriptService)

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local tagColor = Color3.fromRGB(0, 255, 0) -- Green color for ESP tags
local tagName = "ESP_Tag"

local function createOrUpdateTag(character, player)
    if not character or not character:FindFirstChild("HumanoidRootPart") then return end

    local existingTag = character:FindFirstChild(tagName)
    if existingTag then
        -- Update existing tag (you can add more updates here if needed)
        existingTag.Adornee = character.HumanoidRootPart
        existingTag.Text = player.DisplayName
    else
        local billboardGui = Instance.new("BillboardGui")
        billboardGui.Name = tagName
        billboardGui.Adornee = character.HumanoidRootPart
        billboardGui.Size = UDim2.new(0, 5, 0, 1.5) -- Adjust size as needed
        billboardGui.AlwaysOnTop = true
        billboardGui.StudsOffset = Vector3.new(0, 2, 0) -- Adjust offset above head

        local textLabel = Instance.new("TextLabel")
        textLabel.Size = UDim2.new(1, 0, 1, 0)
        textLabel.BackgroundTransparency = 1
        textLabel.TextColor3 = tagColor
        textLabel.TextScaled = true
        textLabel.Text = player.DisplayName
        textLabel.Font = Enum.Font.SourceSansBold

        textLabel.Parent = billboardGui
        billboardGui.Parent = character
    end
end

local function onPlayerAdded(player)
    player.CharacterAdded:Connect(function(character)
        -- Wait a bit for the character to fully load
        wait(1)
        createOrUpdateTag(character, player)
    end)

    player.CharacterRemoving:Connect(function(character)
        local existingTag = character:FindFirstChild(tagName)
        if existingTag then
            existingTag:Destroy()
        end
    end)
end

Players.PlayerAdded:Connect(onPlayerAdded)

-- Update ESP for existing players on server start
for _, player in Players:GetPlayers() do
    if player.Character then
        createOrUpdateTag(player.Character, player)
    end
end

-- Aimlock Script - Client-Sided (Place in a LocalScript under StarterPlayerScripts)

local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local aimKey = Enum.KeyCode.E -- Change this to your desired aim key
local aimRadius = 50 -- Adjust the radius to detect players (in pixels on screen)
local target = nil

local function getClosestPlayer()
    local closestPlayer = nil
    local closestDistance = math.huge
    local screenCenter = Camera.ViewportSize / 2

    for _, player in Players:GetPlayers() do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
            local targetPos, onScreen = Camera:WorldToScreenPoint(player.Character.HumanoidRootPart.Position)
            if onScreen then
                local distance = (targetPos - screenCenter).Magnitude
                if distance < aimRadius and distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player
                end
            end
        end
    end
    return closestPlayer
end

UserInputService.InputBegan:Connect(function(input, gameProcessedEvent)
    if not gameProcessedEvent and input.KeyCode == aimKey then
        target = getClosestPlayer()
    end
end)

UserInputService.InputEnded:Connect(function(input, gameProcessedEvent)
    if not gameProcessedEvent and input.KeyCode == aimKey then
        target = nil
    end
end)

RunService.RenderStepped:Connect(function()
    if target and target.Character and target.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local targetPos = target.Character.HumanoidRootPart.Position
        local myHumanoidRootPart = LocalPlayer.Character.HumanoidRootPart

        -- Calculate the direction to the target
        local direction = (targetPos - myHumanoidRootPart.Position).Unit

        -- Apply the rotation to the player's humanoid root part (you might need to adjust this based on your game's character setup)
        myHumanoidRootPart.CFrame = CFrame.lookAt(myHumanoidRootPart.Position, targetPos) * CFrame.Angles(0, math.rad(180), 0) -- Added a 180-degree rotation to face the target correctly

        -- If your weapon requires aiming the camera, you might need to set the camera's CFrame as well
        -- Camera.CFrame = CFrame.lookAt(Camera.CFrame.Position, targetPos)
    end
end)
print("AIMBOT AND ESP LOADED")
